Got it. Iâ€™m going to treat this like a product+engineering review and give you a complete, end-to-end plan that fixes the journey, closes gaps, and tells Replit exactly what to implement and test.

Below is a deep, actionable blueprint organized around the Customer Journey and Commissioner workflows, with concrete API/db changes, Discord behaviors, tests, and hardening steps. This builds on what you already have (Discord OAuth, bot install, Sleeper link, rules indexing, dashboard) and fills the missing pieces so itâ€™s cohesive and durable.

â¸»

0) Whatâ€™s missing / error-prone right now

Where weâ€™ve seen cracks (from your logs and behavior):
	â€¢	Setup/Discord 500 (UUID empty): backend tried to parse leagueId as UUID when the client sent an empty string â†’ must generate on server if not present.
	â€¢	Bot installed but channels fail: needed structured BOT_NOT_IN_GUILD handling, install URL without redirect_uri, session persistence, and auto-retry after install (you added most of this).
	â€¢	Session cookie churn: fixed by trust proxy, cookie name, SameSite=Lax, and credentials: 'include'.
	â€¢	Caching/old HTML: fixed via no-store headers for HTML and build version header, but keep enforcing.
	â€¢	Dashboard using mocks: real data adapters missing (RAG stats, activity, league stats).
	â€¢	RAG & IDs: some calls read wrong IDs, breaking those tiles.
	â€¢	Sleeper â€œpartialâ€: settings map exists, but no full loop: normalized settings â†’ overrides â†’ constitution render â†’ RAG reindex â†’ Discord behaviors.
	â€¢	No durable reporting pipeline: weekly recap, waivers, trades, standings not wired from Sleeper to dashboard+Discord.
	â€¢	Duplicate/legacy routes: risk of old paths and mocks lingering.

The plan below closes all of that while upgrading UX.

â¸»

1) Customer Journey (end-to-end)

1.1 First Touch â†’ Activation

User goal: Try the product quickly, then convert to â€œbetaâ€ live league.

App (web):
	1.	Landing â†’ â€œTry Demoâ€ (no friction) OR â€œGet Startedâ€.
	2.	Account step (email + name). (Skip if already exists in session.)
	3.	Connect Discord step:
	â€¢	Click â€œConnectâ€.
	â€¢	Choose server â†’ if bot missing, â€œInstall THE COMMISHâ€ (opens in new tab) â†’ auto-retry channels on return.
	â€¢	Choose channel for bot posts (validate bot has View, Send, Embed, Read History, Use Slash).
	â€¢	Doctor gate: â€œDiscord Readyâ€ checklist (permissions, intents, slash commands registered, test ping).
	4.	Link Sleeper step:
	â€¢	Enter Sleeper username + season â†’ we list their leagues â†’ select one.
	â€¢	Click â€œLinkâ€: we persist sleeper_integrations row.
	â€¢	Doctor gate: â€œSleeper Readyâ€ checklist (can fetch /league, snapshot saved, normalized settings present).
	5.	Rules & Constitution step:
	â€¢	Provide Constitution source (upload, paste, URL) and auto-sections from Sleeper settings templates.
	â€¢	â€œApply to Constitutionâ€ (render templates using merged settings) â†’ RAG reindex.
	â€¢	Doctor gate: â€œRules Readyâ€ (index counts, sample Q/A returns non-empty).
	6.	Personality & Digests (optional quick config):
	â€¢	Choose voice preset, pick digests (weekly recap, waivers summary, trades alert).
	7.	â€œFinishâ€ â†’ redirect to /app beta dashboard (non-demo), store selectedLeagueId.

Discord (chat):
	â€¢	On finishing Discord step, bot DMs or posts a single welcome card in the selected channel: â€œHi, Iâ€™m THE COMMISH! Try /settings, /scoring, /waiversâ€.
	â€¢	Slash commands are ready and map to live data.

What was missing before: explicit doctor gates, durable post-install retry, and storing leagueId on completion â†’ now included.

â¸»

1.2 Daily / Weekly Commissioner Experience

Core loops you want:
	â€¢	Live config awareness: Bot and dashboard always reflect merged settings (Sleeper base + commissioner overrides).
	â€¢	Automated reporting (Discord & Dashboard):
	â€¢	Weekly Recap: final scores, top performers, luck/unluck, power rankings.
	â€¢	Waiver Report: results, FAAB spent, steals/bargains.
	â€¢	Trades Monitor: new trades, veto state (if applicable), analysis.
	â€¢	Standings & Playoff Odds (lightweight odds).
	â€¢	Injury/IR Watch: roster compliance nudges (polite + optional).
	â€¢	Engagement:
	â€¢	/poll creation templates (MVP already done), rivalry highlights, â€œmeme thisâ€ for big moments.
	â€¢	Constitution upkeep:
	â€¢	When settings change in Sleeper, surface diffs; a click updates rendered constitution sections & reindexes RAG.
	â€¢	Moderation helpers:
	â€¢	/warn, /clean for message hygiene (if you enable Manage Messages).

UX we add:
	â€¢	A â€œCommissioner Control Centerâ€ panel on the dashboard consolidating:
	â€¢	Sleeper sync status (last synced, counts).
	â€¢	Overrides diff (with quick â€œApply to Constitutionâ€).
	â€¢	Digest schedule settings.
	â€¢	Discord channel health (permission probe results).
	â€¢	Run now buttons with logs.

â¸»

2) Sleeper: full coverage (settings + league data)

What you have: settings mapping stub.
What you need: settings + league activity pipeline.

2.1 DB (add tables)

-- Core roster and players context (minimal)
create table if not exists sleeper_rosters (
  league_id uuid not null references leagues(id) on delete cascade,
  sleeper_roster_id text not null,
  owner_id text,              -- sleeper user/team id
  players jsonb not null default '[]'::jsonb,
  bench jsonb not null default '[]'::jsonb,
  ir jsonb not null default '[]'::jsonb,
  updated_at timestamp default now(),
  primary key (league_id, sleeper_roster_id)
);

-- Transactions (waivers/trades, etc.)
create table if not exists sleeper_transactions (
  league_id uuid not null references leagues(id) on delete cascade,
  tx_id text not null,
  type text not null,         -- 'waiver' | 'trade' | 'free_agent' | ...
  status text,                -- completed/failed/pending
  faab_spent int,
  adds jsonb default '[]'::jsonb,  -- [{player_id, to_roster}]
  drops jsonb default '[]'::jsonb, -- [{player_id, from_roster}]
  parties jsonb default '[]'::jsonb, -- team ids
  processed_at timestamp,
  raw jsonb not null,
  primary key (league_id, tx_id)
);

-- Matchups
create table if not exists sleeper_matchups (
  league_id uuid not null references leagues(id) on delete cascade,
  week int not null,
  matchup_id text not null,
  roster_id_home text,
  roster_id_away text,
  score_home numeric,
  score_away numeric,
  status text, -- scheduled/live/final
  raw jsonb not null,
  primary key (league_id, week, matchup_id)
);

-- Standings snapshots (derived)
create table if not exists league_standings (
  league_id uuid not null references leagues(id) on delete cascade,
  season text not null,
  as_of timestamp not null default now(),
  table jsonb not null, -- [{team, wins, losses, points_for, points_against, streak, ...}]
  primary key (league_id, season, as_of)
);

2.2 Fetchers & schedules
	â€¢	Settings: already via runSleeperSync (every 6h).
	â€¢	Rosters: daily + on Sundays pre-kickoff; on demand for /roster.
	â€¢	Transactions: hourly during season; near-real-time if webhook substitute not available (polling).
	â€¢	Matchups: weekly load; live update window on game days (always backoff and memoize).
	â€¢	Standings: recompute after final scores (Sunday/Tuesday mornings).

All fetchers use ETags/If-None-Match or cheap last-modified checks; idempotent upserts.

2.3 Derived reports
	â€¢	Weekly Recap (computed from matchups + rosters):
	â€¢	Top Score, Narrowest Win, Highest Scorer Player, â€œLuck Indexâ€ (actual PF vs opp PF median), updated standings.
	â€¢	Waivers Report (from transactions):
	â€¢	List by FAAB spent, â€œBargainsâ€ (low cost + high projected), â€œOverpaysâ€ (fun metric).
	â€¢	Trades Digest:
	â€¢	Value balance heuristic (lightweight, avoid heavy ML).
	â€¢	Standings & Playoff Odds:
	â€¢	Simple Elo-ish or win-share projection based on PF/PA trend (MVP: simple sort and a pseudo-odds).

Each report: persisted to bot_activity as queued â†’ posted, with rendered Markdown used both for Discord and a Dashboard â€œpreview / run nowâ€.

â¸»

3) Constitution & RAG: automated bridge

Already planned; tighten it:
	â€¢	Trigger: After runSleeperSync diffs OR when overrides updated.
	â€¢	Render: Regenerate Markdown sections for Slugs (scoring, waivers, roster, playoffs, trades).
	â€¢	Persist: constitution_render + rules_docs.
	â€¢	Index: call your RAG indexer with doc ids and metadata (league-scoped, permission-guarded).
	â€¢	Answer Cards: the bot uses the rendered text for authoritative answers; include source footers (â€œConstitution â–¸ Scoring â–¸ v2025-10-05â€).

â¸»

4) Discord: commands, permissions, behaviors

4.1 Command Matrix

Public (ephemeral by default)
	â€¢	/settings â†’ summary with link to dashboard, shows merged core settings.
	â€¢	/scoring, /waivers, /roster, /playoffs â†’ compact cards from merged settings.
	â€¢	/help â†’ capabilities + examples.

Commissioner-only (role-gated)
	â€¢	/digest run type:<weekly|waivers|trades|standings> â†’ posts in configured channel.
	â€¢	/digest schedule set type:<â€¦> cron:<â€¦> â†’ update scheduler; confirm.
	â€¢	/constitution render â†’ rebuilds sections; confirms count.
	â€¢	/config channel set â†’ chooses post channel; verifies permissions.

Engagement
	â€¢	/poll create (you have), /rivalry set, /meme (attaches template over last highlight).

Guardrails
	â€¢	For guild/channel change commands, always re-probe permissions and emit human-readable diagnosis.

4.2 Events/Reactions (Optional, smart default OFF)
	â€¢	React ğŸ‘ â¤ï¸ on posts matching high-sentiment or key phrases (only if Add Reactions granted and user enables).
	â€¢	Light â€œanti-dramaâ€ nudges: â€œRemember rule X on tradesâ€¦â€ (only if rule is in constitution & user opted in).

â¸»

5) Web App: dashboard tiles & flows

New/updated tiles (real data):
	â€¢	Sleeper Status: last sync, next sync, counts of rosters/matchups/transactions; â€œSync nowâ€.
	â€¢	Settings (merged): show diffs vs overrides; â€œApply to Constitutionâ€.
	â€¢	Reports: Weekly Recap / Waivers / Trades / Standings cards with Preview + Run Now + Schedule.
	â€¢	Activity Log: settings_change_events and bot_activity (filters, pagination).
	â€¢	Health: Discord doctor (permissions & scopes), RAG index counts.

UX polish
	â€¢	When a commissioner clicks Run Now, write bot_activity(queued) and optimistically show a progress bar; on post success, show jump-to-message link (store Discord message id in bot_activity.detail).

â¸»

6) APIs to add/finish (server)

Sleeper
	â€¢	GET /api/v2/sleeper/leagues?username&season â†’ choices
	â€¢	POST /api/v2/setup/sleeper { leagueId, sleeperLeagueId, season, username? }
	â€¢	POST /api/v2/sleeper/sync { leagueId } â†’ returns normalized settings + counts
	â€¢	POST /api/v2/sleeper/fetch { leagueId, what: 'rosters'|'transactions'|'matchups' } (optional on-demand)
	â€¢	GET /api/v2/sleeper/status/:leagueId â†’ { lastSettings, lastRosters, lastTransactions, lastMatchups }

Settings & Constitution
	â€¢	GET /api/v2/settings/:leagueId â†’ { base, overrides, merged }
	â€¢	PUT /api/v2/settings/:leagueId/overrides â†’ partial JSON
	â€¢	POST /api/v2/constitution/:leagueId/render â†’ sections count
	â€¢	POST /api/v2/rag/reindex/:leagueId â†’ (if you want a separate knob)

Reports
	â€¢	POST /api/v2/reports/:leagueId/run { type } â†’ queues & returns bot_activity id
	â€¢	GET /api/v2/reports/:leagueId/preview?type â†’ returns rendered markdown (no post)

Observability
	â€¢	GET /api/_debug/health â†’ add sleeper & reports blocks
	â€¢	GET /api/_debug/routes (admin-key protected)

All POST/PUT use CSRF & Zod; write to bot_activity with idempotency keys.

â¸»

7) Test plan (agentic + E2E)

Agentic clickthrough (Playwright):
	1.	Account â†’ Discord â†’ Bot Install â†’ Channel select â†’ Doctor passes.
	2.	Sleeper link: username â†’ select league â†’ Link passes â†’ Doctor passes.
	3.	Sync now: Sleeper status updates; Settings tile shows values.
	4.	Add override (PPR=0.5) â†’ diff chip appears.
	5.	Apply to Constitution â†’ RAG index count increases; /scoring answers reflect PPR=0.5.
	6.	Run Weekly Recap (with mocked matchup data) â†’ preview renders â†’ â€œRun Nowâ€ posts to test channel â†’ bot_activity shows posted.
	7.	Permissions probe: flip a channel lacking Embed Links â†’ doctor shows red; fix â†’ green.
	8.	Regression: refresh page/session â†’ guilds and channel persist; dashboard in Beta mode, not demo.

Integration tests (vitest/jest):
	â€¢	Mapping unit tests (Sleeper payload â†’ normalized).
	â€¢	Overrides merge tests (nested keys).
	â€¢	Constitution renderer tests (mustache variables).
	â€¢	Reports render tests with sample data.
	â€¢	Idempotency tests: duplicate run doesnâ€™t double-post.

Reliability tests:
	â€¢	Simulate 500/429 from Sleeper; verify backoff and no spam.
	â€¢	Discord post retries with idempotency key.

â¸»

8) Replit hardening (extra oomph)
	â€¢	Secrets hygiene: enforce X-Admin-Key for all debug endpoints; verify no secrets logged.
	â€¢	Kill mocks: gate /api/mock/* behind NODE_ENV !== 'production'; return 410 otherwise.
	â€¢	Cache headers: no-store for HTML; immutable for assets. Keep the BUILD_VERSION header.
	â€¢	Session: ensure cookie name commish.sid, SameSite=Lax, Secure, HttpOnly, trust proxy 1, client fetch uses credentials: 'include'.
	â€¢	Route manifest: run on boot, log a digest (to detect duplicates).
	â€¢	Cost control: run fetchers on a seasonal cadence; use ETags; compute reports only when needed; sample logs.

â¸»

9) Concrete â€œDo this next in Replitâ€ (ordered)
	1.	SQL: create the extra tables (sleeper_rosters, sleeper_transactions, sleeper_matchups, league_standings) + you already have sleeper_integrations, league_settings, overrides, settings_change_events, constitution_*.
	2.	Services: add sleeperClient.ts, sleeperFetchers.ts (rosters/transactions/matchups), and reports.ts (weekly recap, waivers, trades, standings).
	3.	Sync job: wire sleeper.sync (6h) and reports.weekly (Sun night / Tue morning).
	4.	Settings merge: ensure all bot commands read merged settings.
	5.	Constitution render: ensure render â†’ rules_docs â†’ RAG index is one click.
	6.	Dashboard tiles: replace mocks using new endpoints; add Preview/Run Now buttons and a log viewer from bot_activity.
	7.	Doctor gates: Discord doctor + Sleeper doctor must pass before â€œFinish Setupâ€ button enables.
	8.	Slash commands: confirm /scoring, /waivers, /roster, /playoffs, /settings, /digest run work against live data.
	9.	Playwright: add the 8 E2E tests above and run them as a suite.
	10.	Smoke checks: add /api/_debug/health CI gate (returns green blocks for discord/sleeper/rag).

â¸»

10) Acceptance criteria (what we sign off on)
	â€¢	Setup completes without manual fixes; user lands on Beta dashboard with their real league selected.
	â€¢	Bot replies instantly to /settings and the four core rules commands with merged values.
	â€¢	Sleeper Sync runs manually and on schedule; dashboard shows last sync time and counts.
	â€¢	Overrides update the dashboard diff + /scoring output + constitution render in one click.
	â€¢	Weekly Recap preview/Run Now works; Discord post appears; bot_activity records posted.
	â€¢	Doctor gates flag missing Discord permissions and recover when fixed.
	â€¢	E2E: all steps green.

â¸»

This is the full, end-to-end plan to make the customer journey smooth and the commissioner experience powerfulâ€”no more â€œone step, one errorâ€ pain. If you want, I can cut this into:
	â€¢	Replit Work Order.md (copypasteable checklist),
	â€¢	migrations.sql for the tables above, and
	â€¢	stubs for sleeperClient.ts, sleeperFetchers.ts, reports.ts, and the new routes.

Say the word and Iâ€™ll drop those artifacts inline so you can paste them directly into the repo.