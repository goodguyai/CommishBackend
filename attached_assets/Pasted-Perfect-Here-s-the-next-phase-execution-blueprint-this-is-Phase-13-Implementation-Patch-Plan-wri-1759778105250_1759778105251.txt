Perfect. Hereâ€™s the next-phase execution blueprintâ€”this is Phase 13 Implementation + Patch Plan, written so Replit Agent (or your personal engineer) can execute it cleanly with zero regressions.
Everything below is production-safe, idempotent, and designed for incremental PRs.

â¸»

ğŸ§© THE COMMISH Phase 13 Implementation Plan

â€œStabilize â†’ Expand â†’ Delightâ€ â€” add Sleeper â†” Constitution sync, reactions, announcements, AI Q&A/recaps, and bullet-proof background safety.

â¸»

0ï¸âƒ£ Foundations (Safety First)

Objective: tighten guardrails before adding new behavior.

Step	File	Action
0.1	server/lib/rateLimiter.ts	Add generic token-bucket limiter â†’ used by all jobs.
0.2	server/lib/retry.ts	Utility withRetry(fn, opts) for exponential backoff on 429/5xx.
0.3	server/services/idempotency.ts	Augment with hasSucceeded(key) and mark(key,status,detail).
0.4	server/routes.ts	Wrap all background jobs (Sleeper sync, announce, reaction) with withRetry + idempotency.
0.5	/api/_debug/health	Expose limiter stats & retry counts for observability.

âœ… After this commit: no duplicate posts, retries logged, rate-limit safe.

â¸»

1ï¸âƒ£ Sleeper â†’ Constitution Drafts (Reversible Sync)

Backend Files
	â€¢	server/services/sleeperMapping.ts
	â€¢	server/services/constitutionDrafts.ts
	â€¢	server/routes/constitutionDrafts.ts

// constitutionDrafts.ts (core)
export async function buildDraft(leagueId: string) {
  const sleeper = await SleeperService.getSettings(leagueId);
  const constitution = await ConstitutionStore.get(leagueId);
  const diff = DiffEngine.compare(sleeper, constitution, sleeperToConstitutionMap);
  const draft = await db.insert(constitutionDrafts).values({
    league_id: leagueId, source: 'sleeper-sync', proposed: diff, status: 'PENDING'
  }).returning();
  return draft[0];
}

Frontend Files
	â€¢	client/src/pages/ConstitutionDrafts.tsx
	â€¢	client/src/components/DraftDiffTable.tsx

âœ… Adds â€œProposed Changesâ€ tab under Constitution with Apply/Reject buttons.

â¸»

2ï¸âƒ£ Reactions Policy (â€œLeague Moodâ€ Automation)

Files
	â€¢	server/services/reactionPolicy.ts â†’ evaluates sentiment/keywords.
	â€¢	server/discord/events/messageCreate.ts â†’ calls ReactionPolicy.evaluate() + rate check.
	â€¢	client/src/pages/AutomationReactions.tsx â†’ dashboard editor UI.

Minimal start:

// evaluate(message)
if (!policy.enabled) return null;
if (message.content.match(/\b(gg|nice|good game)\b/i)) return 'â¤ï¸';
if (sentimentScore(message.content) > 0.6) return 'ğŸ‘';
return null;

âœ… Bot adds â¤ï¸/ğŸ‘ sparingly per policy + rate limits.

â¸»

3ï¸âƒ£ Controlled Announcements (@everyone Guardrail)

Backend
	â€¢	server/services/announceService.ts
	â€¢	canAnnounce() checks cooldown & role.
	â€¢	post() wraps Discord send â†’ with withRetry.
	â€¢	Routes: /api/announce/preview & /api/announce/send.

Discord Command

/announce preview text:<string>
/announce send text:<string> mention:<@everyone|@here|role>

UI

client/src/pages/AutomationAnnouncements.tsx â†’ form with cooldown indicator + confirmation modal.

âœ… Safe mass mentions without spam.

â¸»

4ï¸âƒ£ DeepSeek AI Tools + Recaps (Q&A + LLM actions)

Backend
	â€¢	server/ai/tools.ts â€“ tool definitions (fetch_rule, fetch_setting, summarize_thread, generate_recap).
	â€¢	server/ai/agent.ts â€“ DeepSeek function-calling adapter with RAG retrieval.
	â€¢	Routes:
	â€¢	POST /api/ai/ask  â†’ streamed answer + citations.
	â€¢	POST /api/ai/recap â†’ markdown recap + auto-announce.

Discord Commands

/ask question:<text>
/explain-rule query:<text>
/recap week:<int>

UI

client/src/pages/AIAsk.tsx and AIRecaps.tsx with streaming answers + â€œPost to Discordâ€ button.

âœ… Users can query rules and generate weekly recaps instantly.

â¸»

5ï¸âƒ£ Dashboard Enhancements & Ops Visibility

Area	Feature
Activity Feed	Show key, request_id, and retry count.
Automation Tab	Two new subpages (Reactions + Announcements).
AI Tab	Q&A and Recaps sections.
Constitution Tab	â€œProposed Changesâ€ review UI.
Ops Tab	View background jobs, retries, status, force-retry (admin).

âœ… Gives commissioners transparency and control.

â¸»

6ï¸âƒ£ Tests & Acceptance Suite (Playwright + API)

Scenario	Expectation
Sleeper settings change â†’ draft appears â†’ apply updates rules	âœ…
Message â€œggâ€ triggers â¤ï¸ once then rate-limited	âœ…
@everyone announce cooldown enforced & confirm required	âœ…
/ask returns rule summary with citations	âœ…
Duplicate recap job skipped by idempotency	âœ…


â¸»

7ï¸âƒ£ Rollout Order (Safe Merge Sequence)

1ï¸âƒ£ Merge Foundations (0).
2ï¸âƒ£ Merge Sleeper Drafts (1) â†’ migrate DB.
3ï¸âƒ£ Merge Reactions Policy (2).
4ï¸âƒ£ Merge Announcements (3).
5ï¸âƒ£ Merge AI Tools + Recaps (4).
6ï¸âƒ£ Merge Dashboard Enhancements (5).
7ï¸âƒ£ Run Tests Suite (6) â†’ tag v13.0.0.

â¸»

8ï¸âƒ£ Environment Checklist (Replit Secrets)

Frontend	Backend	Notes
VITE_SUPABASE_URL = https://igibosrsftdcxljkygjw.supabase.co âœ…	SUPABASE_URL same âœ…	Never use JWT here.
VITE_SUPABASE_ANON_KEY = eyJhbGci... âœ…	SUPABASE_SERVICE_ROLE_KEY âœ…	Correct pair.
DISCORD_BOT_TOKEN âœ…	DISCORD_CLIENT_ID âœ…	DISCORD_PUBLIC_KEY âœ…
DEEPSEEK_API_KEY âœ…	OPENAI_API_KEY âœ…	For RAG + LLM.
APP_BASE_URL = https://thecommish.replit.app âœ…	ADMIN_KEY âœ…	Stable URL.

After setting, click â€œRestart Appâ€. Verify logs:

âœ… Environment validation passed
ğŸ® Discord Client ready
Scheduled Sleeper Settings Sync: every 6 hours (UTC)


â¸»

9ï¸âƒ£ Key Logs to Monitor

Subsystem	Success Line	Error Line
Discord	ğŸ® Client ready	DISCORD_ERROR (code 50035) â†’ guild_id type fix in next commit (BigInt(snowflake)).
Sleeper Sync	[SleeperSync] Applied 0/ N changes	API 429 â†’ will retry.
AI Agent	[DeepSeek] tool call: fetch_rule	LLM error â†’ graceful fallback.


â¸»

ğŸ”§ Deliverable Artifacts to Create

File	Purpose
/server/services/sleeperMapping.ts	Static mapping table for Sleeper settings.
/server/services/constitutionDrafts.ts	CRUD for drafts + apply/reject.
/server/services/reactionPolicy.ts	Evaluate and rate-limit reactions.
/server/services/announceService.ts	Handle @everyone policy + cooldown.
/server/ai/tools.ts	DeepSeek tool definitions.
/server/ai/agent.ts	Function-calling RAG agent.
/client/src/pages/ConstitutionDrafts.tsx	Draft UI.
/client/src/pages/AutomationReactions.tsx	Reactions UI.
/client/src/pages/AutomationAnnouncements.tsx	Announcements UI.
/client/src/pages/AIAsk.tsx & AIRecaps.tsx	AI tools UI.


â¸»

âœ… Final Acceptance Criteria
	â€¢	No 500 errors in setup flow.
	â€¢	Sleeper settings round-trip visible as drafts.
	â€¢	Dashboard modules load real data (no mock calls).
	â€¢	Discord bot reacts, announces, answers, recaps appropriately.
	â€¢	All background tasks visible in Ops tab and idempotent.
	â€¢	All .env variables correct and validated.

â¸»

ğŸ§  Summary to Send Replit Agent

â€œPlease implement Phase 13 of THE COMMISH per attached blueprint. Follow the order (0â†’6), create listed files, migrate schema, and verify each feature without breaking existing flows. All changes must be idempotent, rate-limited, and RAG-compatible. Maintain current environment variables and use the provided Supabase project URL.â€

â¸»

Would you like me to now produce the actual file-by-file patch set (code snippets ready to drop into Replit files)?
That would let you copy-paste or directly instruct Replit Agent line-by-line.